// prisma/schema.prisma       
    
datasource db {      
  provider = "postgresql" // ou "mysql", selon ta base
  url      = env("DATABASE_URL") 
  shadowDatabaseUrl = env("SHADOW_DATABASE_URL")                      
}                 
            
generator client {      
  provider = "prisma-client-js"      
}                                         
       
enum Role {                 
  ADMIN          
  ACHETEUR
  VENDEUR         
  AGENT
  ENTREPRISE   
}    
  
enum Categorie {   
  VILLA
  MAISON   
  APPARTEMENT
  HOTEL
  TERRAIN   
  CHANTIER
}  

enum Mode {
  CASH        
  MIXXBYYAS
  MOOV
  CARTEBANCAIRE
  WESTERNUNION 
  PAYPAL
  STRIPE     
}
  
enum Systeme {         
  SMS  
  MAIL   
  PUSH  
}

enum Statut {
  VENDU   
  DISPONIBLE
  RESERVE
  EN_LOCATION
  EN_NEGOCIATION
}    

enum Type {   
  SEJOUR
  LOCATION   
}   

enum OffreStatut {  
  EN_ATTENTE
  ACCEPTEE
  REFUSEE
  EXPIREE
}

enum ReservationStatut {     
  DEMANDEE
  CONFIRMEE
  ANNULEE
  REPORTEE
}

enum StatutTransaction {
  EN_ATTENTE      // Paiement initi√© mais pas encore compl√©t√©
  EN_COURS        // En cours de traitement
  REUSSIE         // Paiement r√©ussi
  ECHOUEE         // Paiement √©chou√©
  ANNULEE         // Paiement annul√©
  REMBOURSEE      // Transaction rembours√©e
}

enum VisiteStatut {
  DEMANDEE
  CONFIRMEE
  ANNULEE
  REPORTEE
}

enum Theme {
  CLAIR
  SOMBRE
}

enum Langue {
  FR
  EN  
  IT
  ES
  DE
}  

model User {    
  id                Int             @id @default(autoincrement())
  role              Role?
  nom               String  
  prenom            String
  email             String          @unique   
  password          String?
  photo             String?

  // üÜï Param√®tres de profil
  confidentialite   Boolean?        @default(false) // false = public, true = priv√©

  // üîπ Nouvelle propri√©t√© : visibilit√© des annonces
  visibiliteAnnonces Boolean?       @default(true)  // true = annonces publiques, false = annonces priv√©es

  theme             Theme?          @default(CLAIR)
  langue            Langue?         @default(FR)

  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  proprietes        Propriete[]     @relation("UserPropriete")
  visites           Visite[]        @relation("UserVisite")
  visitesAgent      Visite[]        @relation("AgentVisite")
  reservations      Reservation[]   @relation("UserReservation")
  reservationsAgent Reservation[]   @relation("AgentReservation")
  messagesEnvoyes   Message[]       @relation("MessagesEnvoyes")
  messagesRecus     Message[]       @relation("MessagesRecus")
  transactions      Transaction[]   @relation("UserTransaction")   
  transactionsAgent Transaction[]   @relation("AgentTransaction")
  offres            Offre[]         @relation("AcheteurOffre")
  offresAgent       Offre[]         @relation("AgentOffre")
  favoris           Favori[]
  logs              Log[]   
  notifications     Notification[]  @relation("NotificationsRecues")
  notificationsEmises Notification[] @relation("NotificationsEmises")    
  avis              Avis[]    
  recherches        Recherche[] // üëà Ajoute cette ligne
  vus               Vu[]
  signalements      Signalement[]
}          

model Propriete {     
  id                Int             @id @default(autoincrement())
  nom               String        
  description       String?    
  categorie         Categorie
  prix              BigInt?// ‚úÖ permet des valeurs √©normes
  surface           BigInt?// ‚úÖ permet des valeurs √©normes       
  statut            Statut        
  
  images            ProprieteImage[]// üñºÔ∏è Images multiples (UploadThing URLs)

  visiteVirtuelle   String?// üé• Lien unique ou optionnel vers la visite virtuelle (YouTube, Matterport, etc.)  

  geolocalisation   Geolocalisation?     
  
  nombreChambres    Int?             @default(1)/// Nombre total de chambres disponibles (ex: 50 chambres dans un h√¥tel)

  proprietaireId    Int?
  proprietaire      User?           @relation("UserPropriete", fields: [proprietaireId], references: [id], onDelete: Cascade)

  // üÜï Compteur total des vues
  nombreVu          Int             @default(0)
  
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  visites           Visite[]
  reservations      Reservation[]   @relation("ProprieteReservation") 
  offres            Offre[]         @relation("OffrePropriete")
  favoris           Favori[]
  chambres          Chambre[]       @relation("ProprieteChambre")
  avis              Avis[]
  vus               Vu[]
  hotel             Hotel?          @relation("ProprieteHotel")
  signalements      Signalement[]        
}              
        
model Geolocalisation {
  id          Int       @id @default(autoincrement())
  propriete   Propriete @relation(fields: [proprieteId], references: [id], onDelete: Cascade)
  proprieteId Int       @unique
 
  latitude    Float
  longitude   Float     

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt  

  recherches  Recherche[]    
}     

model ProprieteImage {
  id                Int             @id @default(autoincrement())
  url               String          // lien Cloudinary

  ordre             Int             @default(0) // pour trier les images
  proprieteId       Int
  propriete         Propriete       @relation(fields: [proprieteId], references: [id], onDelete: Cascade)  

  createdAt         DateTime         @default(now())     
}     
   
model Hotel {
  id                 Int            @id @default(autoincrement())
  proprieteId        Int            @unique
  propriete          Propriete      @relation("ProprieteHotel", fields: [proprieteId], references: [id], onDelete: Cascade)

  // Sp√©cifiques aux h√¥tels
  nombreVoyageursMax Int?           // capacit√© totale du lieu (optionnel si tu utilises Chambre[])
  nombreEtoiles      Int?           // ex: 3,4,5
  nombreChambresTotal Int?          // r√©sum√© rapide (peut √™tre d√©riv√© de Chambre[])
  disponibilites     Disponibilite[] // plages o√π l'h√¥tel est disponible (ou ferm√©)
  prixParNuitParDefaut BigInt?      // override si tu veux
  politiqueAnnulation String?       // texte court

  chambres           Chambre[]  

  createdAt          DateTime       @default(now())
  updatedAt          DateTime       @updatedAt
}

model Disponibilite {
  id                 Int            @id @default(autoincrement())
  hotelId            Int
  hotel              Hotel          @relation(fields: [hotelId], references: [id], onDelete: Cascade)

  startDate          DateTime
  endDate            DateTime
  disponible         Boolean         @default(true) // true = p√©riode disponible, false = ferm√©/non-disponible

  // optionnel: capacit√© restreinte pour cette plage
  capaciteDisponibilite Int? 

  createdAt          DateTime        @default(now())   

  @@index([hotelId, startDate, endDate])   
}

model Chambre {      
  id                Int              @id @default(autoincrement())
  nom               String
  description       String?
  prixParNuit       Int
  capacite          Int              // nombre max de voyageurs dans cette chambre

  disponible        Boolean          @default(true)
  proprieteId       Int
  propriete         Propriete        @relation("ProprieteChambre", fields: [proprieteId], references: [id], onDelete: Cascade)
  
  // si tu veux lier explicitement √† Hotel (pratique pour h√¥tels multi-chambres par propri√©t√©)
  hotelId           Int?             // facultatif
  hotel             Hotel?           @relation(fields: [hotelId], references: [id], onDelete: Cascade)

  reservations      Reservation[]    @relation("ChambreReservation")

  createdAt         DateTime         @default(now())  
  updatedAt         DateTime         @updatedAt   
}

model Favori {  
  id             Int                @id @default(autoincrement())
  propriete      Propriete          @relation(fields: [proprieteId], references: [id], onDelete: Cascade)
  proprieteId    Int 

  user           User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId         Int

  createdAt      DateTime           @default(now())
  @@unique([userId, proprieteId])

}
  
model Visite {
  id           Int                  @id @default(autoincrement())
  date         DateTime
 
  statut       VisiteStatut         @default(DEMANDEE)
  userId       Int
  user         User                 @relation("UserVisite", fields: [userId], references: [id], onDelete: Cascade)
  
  agentId      Int?
  agent        User?                @relation("AgentVisite", fields: [agentId], references: [id], onDelete: Cascade)

  proprieteId  Int?
  propriete    Propriete?           @relation(fields: [proprieteId], references: [id], onDelete: Cascade)

  createdAt    DateTime             @default(now())
  updatedAt    DateTime             @updatedAt
}      

model Reservation {
  id             Int                @id @default(autoincrement())
  dateArrivee    DateTime
  dateDepart     DateTime       
  nombreVoyageurs Int
  type           Type
  statut         ReservationStatut  @default(DEMANDEE)

  proprieteId    Int?
  propriete      Propriete?         @relation("ProprieteReservation", fields: [proprieteId], references: [id], onDelete: Cascade)

  chambreId      Int?
  chambre        Chambre?           @relation("ChambreReservation", fields: [chambreId], references: [id], onDelete: Cascade)

  userId         Int?
  user           User?              @relation("UserReservation", fields: [userId], references: [id], onDelete: Cascade)

  agentId        Int?
  agent          User?              @relation("AgentReservation", fields: [agentId], references: [id], onDelete: Cascade)  

  offres         Offre[]            @relation("OffreReservation")

  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt

}
  
model Offre {
  id             Int                @id @default(autoincrement())
  montant        BigInt// ‚úÖ permet des valeurs √©normes
  statut         OffreStatut        @default(EN_ATTENTE)
  message        String?     

  userId         Int
  user           User               @relation("AcheteurOffre",fields: [userId], references: [id], onDelete: Cascade)

  agentId        Int?
  agent          User?              @relation("AgentOffre", fields: [agentId], references: [id], onDelete: Cascade)


  proprieteId    Int
  propriete      Propriete          @relation("OffrePropriete", fields: [proprieteId], references: [id], onDelete: Cascade)

  reservationId  Int?
  reservation    Reservation?       @relation("OffreReservation", fields: [reservationId], references: [id], onDelete: Cascade)

  transaction    Transaction?       @relation("OffreTransaction")

  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt
}  

model Transaction {
  id                     Int                @id @default(autoincrement())
  amount                 BigInt
  currency               String             @default("XOF")
  mode                   Mode
  statut                 StatutTransaction  @default(EN_ATTENTE)
  reference              String             @unique

  provider               String?            // stripe, paypal, moov, cinetpay
  providerTransactionId  String?            @unique
  providerPaymentIntent  String?

  fees                   BigInt?   
  netAmount              BigInt?
  paidAt                 DateTime?
  refundedAt             DateTime?
  failureReason          String?
  receiptUrl             String?
     
  metadata               Json?
  
  userId                 Int?
  user                   User?              @relation("UserTransaction", fields: [userId], references: [id], onDelete: Cascade)

  agentId                Int?
  agent                  User?              @relation("AgentTransaction", fields: [agentId], references: [id], onDelete: Cascade)

  offreId                Int?               @unique
  offre                  Offre?             @relation("OffreTransaction", fields: [offreId], references: [id], onDelete: Cascade)

  createdAt              DateTime           @default(now())
  updatedAt              DateTime           @updatedAt
    
  @@index([provider, providerTransactionId])
}
   
model IdempotencyKey {   
  id        Int      @id @default(autoincrement())    
  key       String   @unique
  request   Json?
  response  Json?
  used      Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model PaymentLog {
  id            Int      @id @default(autoincrement())
  transactionId Int?
  level         String
  message       String
  meta          Json?
  createdAt     DateTime @default(now())
}

model Message {
  id             Int                @id @default(autoincrement())
  texte          String  
  date           DateTime 
  fichier        String?

  senderId       Int?
  sender         User?              @relation("MessagesEnvoyes", fields: [senderId], references: [id], onDelete: Cascade)

  receiverId     Int?
  receiver       User?              @relation("MessagesRecus", fields: [receiverId], references: [id], onDelete: Cascade)
   
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt
}
  
model Avis {
  id             Int                @id @default(autoincrement())
  commentaire    String?// texte optionnel    

  note           Int// de 1 √† 5 par ex.
  
  proprieteId    Int
  propriete      Propriete          @relation(fields: [proprieteId], references: [id], onDelete: Cascade)

  userId         Int
  user           User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt      DateTime           @default(now())  
  updatedAt      DateTime           @updatedAt

  @@unique([proprieteId, userId]) // üëà un user ne peut noter une propri√©t√© qu‚Äôune seule fois
}   


model Log {
  id             Int                @id @default(autoincrement())
  action         String             // ex: "CREATION_PROPRIETE", "RESERVATION"

  userId         Int?
  user           User?              @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt
}
      
model Notification {    
  id             Int                @id @default(autoincrement())
  systeme        Systeme
  contenu        String             // message √† afficher/envoyer

  userId         Int?
  user           User?              @relation("NotificationsRecues", fields: [userId], references: [id], onDelete: Cascade)

  emetteurId     Int?               
  emetteur       User?              @relation("NotificationsEmises", fields: [emetteurId], references: [id], onDelete: Cascade)

  vu               Boolean          @default(false)
  dateNotification DateTime         @default(now())
  lien            String?

  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt       
}         
  
model Config {
  id             Int                @id @default(1)
  maintenance    Boolean            @default(false)  
}    
  
model Recherche { 
  id             Int                 @id @default(autoincrement())
  userId         Int
  user           User                @relation(fields: [userId], references: [id], onDelete: Cascade)

  titre          String?    // ex: "Mes villas √† Lom√©"
  categorie      Categorie? // ex: VILLA, MAISON...
  minPrix        BigInt?
  maxPrix        BigInt?
  minSurface     BigInt?
  maxSurface     BigInt?

  geolocalisation  Geolocalisation? @relation(fields: [geolocalisationId], references: [id])
  geolocalisationId Int?             // optionnel, pour la relation

  statut         Statut?    // DISPONIBLE, VENDU...
  nombreChambres Int?      // ex: 3

  // facultatif : pour trier ou filtrer plus tard
  triPar         String?    // ex: "prix_asc", "surface_desc"
  motsCles       String?    // ex: "vue sur mer, piscine"

  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt
} 

model Vu {
  id             Int                 @id @default(autoincrement())
  
  // üßç Utilisateur ayant consult√© la propri√©t√©
  userId         Int?
  user           User?               @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // üè† Propri√©t√© consult√©e
  proprieteId    Int
  propriete      Propriete           @relation(fields: [proprieteId], references: [id], onDelete: Cascade)
  
  // üìÖ Date de la consultation
  dateVu         DateTime   @default(now())

  @@unique([userId, proprieteId]) // ‚úÖ √âvite les doublons (un utilisateur ne compte qu'une fois par propri√©t√©)
}

model Signalement {
  id           Int        @id @default(autoincrement())
  proprieteId  Int
  propriete    Propriete  @relation(fields: [proprieteId], references: [id], onDelete: Cascade)

  userId       Int
  user         User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  raison       String     // Ex: "Annonce frauduleuse", "Prix incorrect", "Contenu inappropri√©"
  description  String?    // D√©tails optionnels

  statut       String     @default("EN_ATTENTE") // EN_ATTENTE, TRAITE, REJETE
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  @@index([proprieteId])
  @@index([userId])
}

         